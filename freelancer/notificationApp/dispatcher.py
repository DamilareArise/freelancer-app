from accounts.models import User
from .models import NotificationTemplate, Notification
from django.utils import timezone
from .services import SENDER_REGISTRY
from .scheduler import should_send_template



def _resolve_recipients(recipient_list):
    """Return queryset of users based on the recipients field."""

    qs = User.objects.filter(is_active=True)

    selected_roles = []

    if "user" in recipient_list:
        selected_roles.append("CUSTOMER")

    if "service_provider" in recipient_list:
        selected_roles.append("SERVICE_PROVIDER")

    # If both roles were selected â†’ return all users that match ANY of them
    if len(selected_roles) == 2:
        return qs.filter(user_roles__role__id__in=selected_roles).distinct()

    # If only "user"
    if selected_roles == ["CUSTOMER"]:
        return qs.filter(
            user_roles__role__id="CUSTOMER"
        ).exclude(
            user_roles__role__id="SERVICE_PROVIDER"
        ).distinct()

    # If only "service_provider"
    if selected_roles == ["SERVICE_PROVIDER"]:
        return qs.filter(
            user_roles__role__id="SERVICE_PROVIDER"
        ).distinct()

    # Default fallback: no recipients
    return User.objects.none()



def dispatch_notifications():
    """Loops through all notification templates and sends notifications."""

    templates = NotificationTemplate.objects.all()

    for template in templates:
        
        if not should_send_template(template):
            continue
        
        recipients = _resolve_recipients(template.recipients)

        for user in recipients:
            for notif_type in template.types:

                sender_class = SENDER_REGISTRY.get(notif_type)
                if not sender_class:
                    continue

                # Create the Notification log row (pending status)
                notification_log = Notification.objects.create(
                    template=template,
                    recipient_user=user,
                    channel=notif_type,
                    status=Notification.Status.PENDING,
                )

                try:
                    # Initialize and send via the appropriate sender class
                    sender = sender_class(notification_log)
                    sender.send()

                    notification_log.status = Notification.Status.SENT
                    notification_log.sent_at = timezone.now()

                except Exception as e:
                    notification_log.status = Notification.Status.FAILED
                    notification_log.error_message = str(e)

                notification_log.save()
                
        template.last_sent_at = timezone.now()
        template.save()